<!DOCTYPE html>
<html lang="en" translate="no" class="notranslate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="google" content="notranslate">
    <title>Framework Sandbox</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="js/designer-engine.js"></script>

    <style>
        html, body, #root {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #ffffff;
            touch-action: none;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .ui-interactive {
            touch-action: auto;
            pointer-events: auto;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .svg-content path { transition: fill 0.2s, stroke 0.2s; }
        .cursor-crosshair { cursor: crosshair; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback, memo } = React;

        // --- Configuration ---
        const ZOOM_PADDING = 40; 
        const LADY_URL = 'images/designer/context/cxt_woman-book-1.svg';
        const SNAP_PX = 15;
        const MM_PER_PX = (2000 / 0.8165) / 240;

        // --- Helpers ---
        const getPointer = (e) => {
            if (e.touches) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        };

        // Extracts geometric points from SVG path data
        const extractPathPoints = (d) => {
            const points = [];
            const regex = /[ML]\s*([\d\.-]+)[,\s]([\d\.-]+)/gi;
            let match;
            while ((match = regex.exec(d)) !== null) {
                points.push({ x: parseFloat(match[1]), y: parseFloat(match[2]) });
            }
            return points;
        };

        const projectPointToLine = (start, angleDeg, p) => {
            const rad = angleDeg * (Math.PI / 180);
            const ux = Math.cos(rad);
            const uy = Math.sin(rad);
            const vx = p.x - start.x;
            const vy = p.y - start.y;
            const dot = vx * ux + vy * uy;
            return { x: start.x + dot * ux, y: start.y + dot * uy, dist: dot };
        };

        // --- Components ---

        const SvgLoader = memo(({ id, theme, className, onParsed }) => {
            const [svgContent, setSvgContent] = useState(null);

            useEffect(() => {
                let active = true;
                let src = id;
                
                if (!id.includes('/') && window.DesignerEngine?.testPieces) {
                    const piece = window.DesignerEngine.testPieces.find(p => p.id === id);
                    if (piece) src = piece.imagePath;
                }

                fetch(src).then(res => res.text()).then(text => {
                    if (!active) return;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'image/svg+xml');
                    
                    // 1. EXTRACT POINTS BEFORE THEME APPLICATION
                    // We need to find points associated with #777777 (grey fills) specifically for structural snapping
                    const structuralPoints = [];
                    const allPoints = [];

                    Array.from(doc.querySelectorAll('path, rect, polygon')).forEach(el => {
                        const style = window.getComputedStyle(el);
                        // Check explicit attribute or computed style for the target grey color
                        const fill = el.getAttribute('fill');
                        const isStructural = fill && (fill.toLowerCase() === '#777777' || fill === '#777');
                        
                        let d = el.getAttribute('d');
                        if (!d && el.tagName === 'rect') {
                            // Synthesize rect path for consistency
                            const x = parseFloat(el.getAttribute('x')||0);
                            const y = parseFloat(el.getAttribute('y')||0);
                            const w = parseFloat(el.getAttribute('width'));
                            const h = parseFloat(el.getAttribute('height'));
                            d = `M${x},${y} L${x+w},${y} L${x+w},${y+h} L${x},${y+h}`;
                        }

                        if (d) {
                            const pts = extractPathPoints(d);
                            allPoints.push(...pts);
                            if (isStructural) structuralPoints.push(...pts);
                        }
                    });

                    // 2. APPLY THEME
                    if (window.DesignerEngine && window.DesignerEngine.applySVGTheme) {
                        window.DesignerEngine.applySVGTheme(doc, theme);
                    }

                    // 3. SET ACCESSIBILITY
                    const svg = doc.documentElement;
                    svg.setAttribute('style', 'pointer-events: none; width: 100%; height: 100%; overflow: visible;');
                    Array.from(svg.querySelectorAll('path, rect, circle, polygon')).forEach(el => {
                         const style = window.getComputedStyle(el);
                         if ((el.getAttribute('fill') && el.getAttribute('fill') !== 'none') || 
                             (style.fill && style.fill !== 'none') || 
                             (el.getAttribute('stroke') && el.getAttribute('stroke') !== 'none')) {
                             el.style.pointerEvents = 'auto';
                         }
                    });

                    setSvgContent(svg.outerHTML);
                    if (onParsed) onParsed({ structural: structuralPoints, all: allPoints });
                }).catch(e => {});
                return () => active = false;
            }, [id, theme]);

            if (!svgContent) return <div className="w-full h-full animate-pulse bg-gray-100 rounded-lg"></div>;
            return <div className={`svg-content ${className}`} dangerouslySetInnerHTML={{ __html: svgContent }} />;
        });

        const DimensionRenderer = ({ mod, isSelected, onDown }) => {
            const mm = Math.ceil(Math.abs(mod.length * MM_PER_PX) / 10) * 10;
            const color = isSelected ? '#3b82f6' : '#000';
            
            // Perpendicular ticks logic
            let tickRot = 0;
            if (mod.angle === 30) tickRot = 120; 
            else if (mod.angle === 150) tickRot = -120;
            else if (mod.angle === 90) tickRot = 90; 

            return (
                <div 
                    onMouseDown={(e) => onDown(e, 'dimension', mod.id)}
                    onTouchStart={(e) => onDown(e, 'dimension', mod.id)}
                    style={{
                        position: 'absolute',
                        transform: `translate(${mod.x}px, ${mod.y}px) rotate(${mod.angle}deg)`,
                        width: Math.max(1, mod.length) + 'px', height: '20px',
                        transformOrigin: '0 0', zIndex: mod.zIndex + 100,
                        cursor: 'grab', pointerEvents: 'auto'
                    }}
                >
                    <div style={{ position: 'absolute', top: 0, left: 0, right: 0, height: '1px', background: color }}></div>
                    <div style={{ position: 'absolute', top: 0, left: 0, width: '10px', height: '1px', background: color, transformOrigin: '0 0', transform: `rotate(${tickRot}deg) translate(-5px, 0)` }}></div>
                    <div style={{ position: 'absolute', top: 0, right: 0, width: '10px', height: '1px', background: color, transformOrigin: '100% 0', transform: `rotate(${tickRot}deg) translate(5px, 0)` }}></div>
                    <div style={{
                        position: 'absolute', left: '50%', top: '-18px',
                        transform: `translateX(-50%) rotate(${mod.angle > 90 && mod.angle < 270 ? 180 : 0}deg)`,
                        fontSize: '10px', fontWeight: 'bold', color: color,
                        textShadow: '0 0 3px white', whiteSpace: 'nowrap'
                    }}>
                        {mm}mm
                    </div>
                    {isSelected && (
                        <div className="absolute left-1/2 top-0 w-8 h-8 -ml-4 -mt-4 bg-white border-2 border-blue-500 rounded-full shadow-lg z-50 flex items-center justify-center">
                            <span className="text-blue-500 font-bold text-[10px]">↔</span>
                        </div>
                    )}
                </div>
            );
        };

        // --- Main Sandbox ---
        const Sandbox = () => {
            const [modules, setModules] = useState([]);
            const [history, setHistory] = useState([]);
            const [camera, setCamera] = useState({ x: 0, y: 0, scale: 1 });
            const [selectedId, setSelectedId] = useState(null);
            
            // UI
            const [isPaletteOpen, setIsPaletteOpen] = useState(false);
            const [isPriceOpen, setIsPriceOpen] = useState(false);
            const [theme, setTheme] = useState('THEME_1');
            const [uiHidden, setUiHidden] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [snapEnabled, setSnapEnabled] = useState(true);
            
            // Measure Tool
            const [measureMode, setMeasureMode] = useState(null); 
            const [measureStart, setMeasureStart] = useState(null);
            const [measurePreview, setMeasurePreview] = useState(null);
            const [snapHighlight, setSnapHighlight] = useState(null);

            const containerRef = useRef(null);
            const dragRef = useRef({ isDragging: false, isPanning: false, startX: 0, startY: 0, targetId: null, snapAnchorOffset: {x:0, y:0} });

            // -- Logic --
            const getEngineData = () => window.DesignerEngine?.testPieces || [];

            const pushHistory = useCallback((newModules) => {
                setHistory(prev => [...prev.slice(-10), JSON.stringify(modules)]);
                setModules(newModules);
            }, [modules]);

            const undo = () => {
                if (history.length === 0) return;
                const prev = history[history.length - 1];
                setHistory(h => h.slice(0, -1));
                setModules(JSON.parse(prev));
                setSelectedId(null);
            };

            const zoomCenter = (factor) => {
                if (!containerRef.current) return;
                const c = containerRef.current;
                const center = { x: c.clientWidth / 2, y: c.clientHeight / 2 };
                const wx = (center.x - camera.x) / camera.scale;
                const wy = (center.y - camera.y) / camera.scale;
                const newScale = Math.min(Math.max(camera.scale * factor, 0.2), 3);
                setCamera({
                    scale: newScale,
                    x: center.x - wx * newScale,
                    y: center.y - wy * newScale
                });
            };

            // Init
            useEffect(() => {
                const load = () => {
                    const hash = window.location.hash.slice(1);
                    if (!hash) return;
                    try {
                        const [code, themeCode] = hash.split(';');
                        if (themeCode && window.DesignerEngine?.colorThemes[themeCode]) setTheme(themeCode);
                        if (code.startsWith('SBX:')) {
                            setModules(JSON.parse(decodeURIComponent(code.substring(4))));
                            setTimeout(() => requestAnimationFrame(autoZoom), 200);
                        }
                    } catch (e) {}
                };
                load();
                window.addEventListener('hashchange', load);
                return () => window.removeEventListener('hashchange', load);
            }, []);

            useEffect(() => {
                if (modules.length > 0) {
                    // Strip snap data before saving
                    const data = JSON.stringify(modules.map(m => {
                        const { snapData, ...rest } = m; 
                        return rest;
                    }));
                    const hash = `SBX:${encodeURIComponent(data)};${theme}`;
                    const timer = setTimeout(() => window.history.replaceState(null, null, '#' + hash), 500);
                    return () => clearTimeout(timer);
                }
            }, [modules, theme]);

            const autoZoom = useCallback(() => {
                if (modules.length === 0 || !containerRef.current) return;
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                modules.forEach(m => {
                    const w = m.type === 'dimension' ? m.length : 240; 
                    minX = Math.min(minX, m.x); minY = Math.min(minY, m.y);
                    maxX = Math.max(maxX, m.x + w); maxY = Math.max(maxY, m.y + 240);
                });
                const container = containerRef.current;
                const scaleX = (container.clientWidth - ZOOM_PADDING * 2) / (maxX - minX);
                const scaleY = (container.clientHeight - ZOOM_PADDING * 2) / (maxY - minY);
                const newScale = Math.min(Math.max(Math.min(scaleX, scaleY), 0.2), 1.8);
                setCamera({
                    scale: newScale,
                    x: (container.clientWidth / 2) - ((minX + (maxX - minX)/2) * newScale),
                    y: (container.clientHeight / 2) - ((minY + (maxY - minY)/2) * newScale)
                });
            }, [modules]);

            // -- Snapping Core --
            const findGlobalSnapPoint = (worldX, worldY, excludeId, useRestrictedPoints = false) => {
                if (!snapEnabled) return null;
                let best = null;
                let minDist = SNAP_PX / camera.scale;
                
                modules.forEach(m => {
                    if (m.id === excludeId || m.type === 'dimension' || !m.snapData) return;
                    
                    // Determine which point set to use
                    // Moving modules -> snap only to structural (#777)
                    // Dimensions -> snap to all visible
                    const points = useRestrictedPoints ? m.snapData.structural : m.snapData.all;
                    
                    points.forEach(pt => {
                        const wx = m.x + pt.x * 2; // Scale factor 2 (120->240)
                        const wy = m.y + pt.y * 2;
                        const dist = Math.sqrt(Math.pow(wx - worldX, 2) + Math.pow(wy - worldY, 2));
                        if (dist < minDist) {
                            minDist = dist;
                            best = { x: wx, y: wy };
                        }
                    });
                });
                return best;
            };

            const findModuleLocalSnap = (mod, worldX, worldY) => {
                if (!mod.snapData) return null;
                let best = null;
                let minDist = Infinity;
                // When picking up a module, we prefer structural points as anchors
                mod.snapData.structural.forEach(pt => {
                    const wx = mod.x + pt.x * 2;
                    const wy = mod.y + pt.y * 2;
                    const dist = Math.sqrt(Math.pow(wx - worldX, 2) + Math.pow(wy - worldY, 2));
                    if (dist < minDist) {
                        minDist = dist;
                        best = { x: pt.x * 2, y: pt.y * 2 }; 
                    }
                });
                return best || { x: 120, y: 120 }; 
            };

            const handlePointerDown = (e, type, id) => {
                const pt = getPointer(e);
                const worldPt = { x: (pt.x - camera.x) / camera.scale, y: (pt.y - camera.y) / camera.scale };

                if (measureMode) {
                    e.stopPropagation();
                    // Dimensions snap to EVERYTHING
                    const snap = findGlobalSnapPoint(worldPt.x, worldPt.y, null, false);
                    const target = snap || worldPt;

                    if (!measureStart) {
                        setMeasureStart(target);
                    } else {
                        const angle = measureMode === 'vert' ? 90 : (measureMode === '30' ? 30 : 150);
                        const proj = projectPointToLine(measureStart, angle, target);
                        let length = proj.dist;
                        let start = measureStart;
                        if (length < 0) {
                            start = { x: measureStart.x + length * Math.cos(angle*Math.PI/180), y: measureStart.y + length * Math.sin(angle*Math.PI/180) };
                            length = Math.abs(length);
                        }
                        if (length > 5) {
                            const newDim = { id: Date.now().toString(), type: 'dimension', x: start.x, y: start.y, length: length, angle: angle, zIndex: 9999 };
                            pushHistory([...modules, newDim]);
                        }
                        setMeasureMode(null); setMeasureStart(null); setMeasurePreview(null); setSnapHighlight(null);
                    }
                    return;
                }

                dragRef.current.startX = pt.x;
                dragRef.current.startY = pt.y;
                
                if (type === 'bg') {
                    dragRef.current.isPanning = true;
                    dragRef.current.initialCamX = camera.x;
                    dragRef.current.initialCamY = camera.y;
                    setSelectedId(null);
                } else if (type === 'module' || type === 'dimension') {
                    e.stopPropagation(); 
                    dragRef.current.isDragging = true;
                    dragRef.current.targetId = id;
                    const mod = modules.find(m => m.id === id);
                    dragRef.current.initialModX = mod.x;
                    dragRef.current.initialModY = mod.y;
                    
                    if (mod.type === 'module') {
                        const localAnchor = findModuleLocalSnap(mod, worldPt.x, worldPt.y);
                        dragRef.current.snapAnchorOffset = localAnchor;
                    } else {
                        dragRef.current.snapAnchorOffset = { x: 0, y: 0 };
                    }
                    setSelectedId(id);
                }
            };

            const handlePointerMove = (e) => {
                const pt = getPointer(e);
                const worldPt = { x: (pt.x - camera.x) / camera.scale, y: (pt.y - camera.y) / camera.scale };

                if (measureMode) {
                    const snap = findGlobalSnapPoint(worldPt.x, worldPt.y, null, false);
                    setSnapHighlight(snap);
                    const target = snap || worldPt;
                    if (measureStart) {
                        const angle = measureMode === 'vert' ? 90 : (measureMode === '30' ? 30 : 150);
                        const proj = projectPointToLine(measureStart, angle, target);
                        setMeasurePreview({ x: measureStart.x, y: measureStart.y, endX: proj.x, endY: proj.y });
                    }
                    return;
                }

                const dx = pt.x - dragRef.current.startX;
                const dy = pt.y - dragRef.current.startY;

                if (dragRef.current.isPanning) {
                    setCamera(prev => ({ ...prev, x: dragRef.current.initialCamX + dx, y: dragRef.current.initialCamY + dy }));
                } 
                
                if (dragRef.current.isDragging && dragRef.current.targetId) {
                    const worldDx = dx / camera.scale;
                    const worldDy = dy / camera.scale;
                    let newX = dragRef.current.initialModX + worldDx;
                    let newY = dragRef.current.initialModY + worldDy;
                    
                    const mod = modules.find(m => m.id === dragRef.current.targetId);
                    
                    // -- MODULE SNAPPING (Restricted to Structural Points) --
                    if (mod.type === 'module' && dragRef.current.snapAnchorOffset && snapEnabled) {
                        const anchorX = newX + dragRef.current.snapAnchorOffset.x;
                        const anchorY = newY + dragRef.current.snapAnchorOffset.y;
                        
                        // Pass 'true' to restrict target points to structural only
                        const snapTarget = findGlobalSnapPoint(anchorX, anchorY, mod.id, true);
                        
                        if (snapTarget) {
                            newX = snapTarget.x - dragRef.current.snapAnchorOffset.x;
                            newY = snapTarget.y - dragRef.current.snapAnchorOffset.y;
                            setSnapHighlight(snapTarget);
                        } else {
                            setSnapHighlight(null);
                        }
                    }

                    setModules(prev => prev.map(m => m.id === dragRef.current.targetId ? { ...m, x: newX, y: newY } : m));
                }
            };

            const handlePointerUp = () => {
                if (dragRef.current.isDragging) pushHistory(modules);
                dragRef.current.isPanning = false;
                dragRef.current.isDragging = false;
                dragRef.current.targetId = null;
                setSnapHighlight(null);
            };

            // -- Logic --
            const addModule = (id, isContext) => {
                const cx = (containerRef.current.clientWidth/2 - camera.x)/camera.scale;
                const cy = (containerRef.current.clientHeight/2 - camera.y)/camera.scale;
                const newMod = { id: Date.now().toString(), type: 'module', pieceId: id, x: cx - 120, y: cy - 120, zIndex: modules.length+1, isContext };
                pushHistory([...modules, newMod]);
                setIsPaletteOpen(false); setSelectedId(newMod.id);
            };

            const duplicateModule = (id) => {
                const m = modules.find(x => x.id === id);
                if (!m) return;
                const copy = { ...m, id: Date.now().toString(), x: m.x+30, y: m.y+30, zIndex: modules.length+1 };
                pushHistory([...modules, copy]);
                setSelectedId(copy.id);
            };

            const removeModule = (id) => {
                pushHistory(modules.filter(m => m.id !== id));
                setSelectedId(null);
            };

            const swapModule = (mod) => {
                if (mod.type !== 'module') return;
                const data = getEngineData();
                const currentPiece = data.find(p => p.id === mod.pieceId);
                if (!currentPiece) return;
                const products = [...new Set(data.map(p => p.product))];
                const nextProd = products[(products.indexOf(currentPiece.product)+1) % products.length];
                let next = data.find(p => p.product === nextProd && p.id.includes('NE')) || data.find(p => p.product === nextProd);
                if (next) pushHistory(modules.map(m => m.id === mod.id ? { ...m, pieceId: next.id } : m));
            };

            const rotateModule = (mod) => {
                if (mod.type !== 'module') return;
                const data = getEngineData();
                const currentPiece = data.find(p => p.id === mod.pieceId);
                const variants = data.filter(p => p.product === currentPiece.product);
                const next = variants[(variants.findIndex(v => v.id === mod.pieceId) + 1) % variants.length];
                pushHistory(modules.map(m => m.id === mod.id ? { ...m, pieceId: next.id } : m));
            };

            const cycleColor = (mod) => {
                if (mod.type !== 'module') return;
                const themes = Object.keys(window.DesignerEngine.colorThemes);
                const next = themes[(themes.indexOf(mod.customTheme || theme) + 1) % themes.length];
                pushHistory(modules.map(m => m.id === mod.id ? { ...m, customTheme: next } : m));
            };

            const filteredMenu = useMemo(() => {
                const unique = []; const seen = new Set();
                getEngineData().forEach(m => {
                    if (!seen.has(m.product) && m.product.toLowerCase().includes(searchQuery.toLowerCase())) {
                        unique.push(getEngineData().find(v => v.product === m.product && v.id.includes('NE')) || m);
                        seen.add(m.product);
                    }
                });
                return unique;
            }, [searchQuery, isPaletteOpen]);

            const totalPrice = useMemo(() => modules.reduce((s,m) => {
                const p = getEngineData().find(tp => tp.id === m.pieceId);
                return (m.type==='module' && !m.isContext && p) ? s + p.price : s;
            }, 0), [modules]);

            const itemBreakdown = useMemo(() => {
                const counts = {};
                if (!window.DesignerEngine?.testPieces) return counts;
                modules.forEach(m => {
                    if (m.type === 'dimension' || m.isContext) return;
                    const p = window.DesignerEngine.testPieces.find(tp => tp.id === m.pieceId);
                    if (p) {
                        if (!counts[p.product]) counts[p.product] = { count: 0, price: p.price };
                        counts[p.product].count++;
                    }
                });
                return counts;
            }, [modules]);

            return (
                <div className={`w-full h-full relative overflow-hidden font-sans text-gray-800 ${measureMode ? 'cursor-crosshair' : ''}`}
                    onMouseMove={handlePointerMove} onMouseUp={handlePointerUp} onMouseDown={(e) => handlePointerDown(e, 'bg')}
                    onTouchMove={handlePointerMove} onTouchEnd={handlePointerUp} onTouchStart={(e) => handlePointerDown(e, 'bg')}>
                    
                    {/* Top Bar */}
                    <div className={`absolute top-0 left-0 right-0 p-4 flex justify-between items-start pointer-events-none z-20 transition-opacity ${uiHidden ? 'opacity-0' : 'opacity-100'}`}>
                        <div className="flex flex-col gap-2 ui-interactive" onMouseDown={e => e.stopPropagation()}>
                             <div className="flex gap-2">
                                <a href="/" className="glass-panel shadow-sm rounded-full w-10 h-10 flex items-center justify-center text-gray-700 font-bold hover:bg-white">←</a>
                                <button onClick={() => {
                                    const ks = Object.keys(window.DesignerEngine.colorThemes);
                                    setTheme(ks[(ks.indexOf(theme)+1)%ks.length]);
                                }} className="glass-panel shadow-sm px-3 h-10 rounded-full text-xs font-bold text-gray-700 flex items-center gap-2 hover:bg-white">
                                    <div className="w-4 h-4 rounded-full border border-gray-300" style={{backgroundColor: window.DesignerEngine.colorThemes[theme].parameterMappings.SET_1.fill}}></div>
                                    {window.DesignerEngine.colorThemes[theme].displayName}
                                </button>
                                {modules.some(m => m.customTheme) && (
                                    <button onClick={() => pushHistory(modules.map(m => ({ ...m, customTheme: null })))} className="glass-panel shadow-sm w-10 h-10 rounded-full flex items-center justify-center hover:bg-white text-red-500" title="Reset Colors">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><line x1="2" y1="2" x2="22" y2="22"/></svg>
                                    </button>
                                )}
                            </div>
                            
                            <div className="flex items-center gap-1 glass-panel px-2 py-1.5 rounded-full shadow-sm mt-2 pointer-events-auto">
                                <span className="text-[9px] font-bold text-gray-400 uppercase mr-1 tracking-wider">Measure</span>
                                <button onClick={() => { setMeasureMode('vert'); setMeasureStart(null); }} className={`w-8 h-8 rounded-full flex items-center justify-center ${measureMode === 'vert' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100'}`}><svg width="12" height="20" viewBox="0 0 12 20"><line x1="6" y1="2" x2="6" y2="18" stroke="currentColor" strokeWidth="2"/><line x1="3" y1="2" x2="9" y2="2" stroke="currentColor" strokeWidth="2"/><line x1="3" y1="18" x2="9" y2="18" stroke="currentColor" strokeWidth="2"/></svg></button>
                                {/* Corrected Buttons */}
                                <button onClick={() => { setMeasureMode('150'); setMeasureStart(null); }} className={`w-8 h-8 rounded-full flex items-center justify-center ${measureMode === '150' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100'}`}><svg width="20" height="20" viewBox="0 0 20 20"><line x1="16" y1="16" x2="4" y2="4" stroke="currentColor" strokeWidth="2" transform="rotate(-15 10 10)"/></svg></button>
                                <button onClick={() => { setMeasureMode('30'); setMeasureStart(null); }} className={`w-8 h-8 rounded-full flex items-center justify-center ${measureMode === '30' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100'}`}><svg width="20" height="20" viewBox="0 0 20 20"><line x1="4" y1="16" x2="16" y2="4" stroke="currentColor" strokeWidth="2" transform="rotate(15 10 10)"/></svg></button>
                            </div>
                        </div>

                        <div className="ui-interactive flex gap-2" onMouseDown={e => e.stopPropagation()}>
                             {history.length > 0 && (
                                <button onClick={undo} className="glass-panel shadow-sm w-10 h-10 rounded-full flex items-center justify-center text-gray-600 hover:bg-white">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
                                </button>
                             )}
                             <button onClick={() => { if(confirm("Clear?")) pushHistory([]); }} className="glass-panel shadow-sm w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-red-500">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                             </button>
                             <button onClick={() => zoomCenter(0.8)} className="glass-panel shadow-sm w-10 h-10 rounded-full flex items-center justify-center text-xl hover:bg-white">-</button>
                             <button onClick={() => zoomCenter(1.2)} className="glass-panel shadow-sm w-10 h-10 rounded-full flex items-center justify-center text-xl hover:bg-white">+</button>
                             <button onClick={autoZoom} className="glass-panel shadow-sm w-10 h-10 rounded-full flex items-center justify-center text-xl hover:bg-white">⤢</button>
                        </div>
                    </div>

                    {/* Canvas */}
                    <div ref={containerRef} className="absolute inset-0">
                        <div style={{ transform: `translate(${camera.x}px, ${camera.y}px) scale(${camera.scale})`, transformOrigin: '0 0', width: 0, height: 0 }}>
                            {modules.sort((a,b) => (a.zIndex||0) - (b.zIndex||0)).map(m => {
                                if (m.type === 'dimension') {
                                    return <DimensionRenderer key={m.id} mod={m} isSelected={selectedId === m.id} onDown={handlePointerDown} />;
                                }
                                return (
                                    <div key={m.id} style={{ position: 'absolute', transform: `translate(${m.x}px, ${m.y}px)`, width: '240px', height: '240px', zIndex: m.zIndex, pointerEvents: 'none' }}>
                                        <div style={{ width: '100%', height: '100%', filter: selectedId===m.id ? 'drop-shadow(0 0 8px rgba(59, 130, 246, 0.6))' : 'none', transition: 'filter 0.2s ease', pointerEvents: 'none' }}>
                                            <div onMouseDown={(e) => handlePointerDown(e, 'module', m.id)} onTouchStart={(e) => handlePointerDown(e, 'module', m.id)} style={{ pointerEvents: 'none', width: '100%', height: '100%' }}>
                                                <SvgLoader id={m.isContext ? LADY_URL : m.pieceId} theme={m.customTheme || theme} onParsed={(pts) => setModules(prev => prev.map(mod => mod.id === m.id ? { ...mod, snapData: pts } : mod))} />
                                            </div>
                                            {selectedId === m.id && <div className="absolute left-1/2 top-1/2 w-10 h-10 -ml-5 -mt-5 bg-white border-2 border-blue-500 rounded-full shadow-lg z-50 flex items-center justify-center cursor-move pointer-events-auto" onMouseDown={(e) => handlePointerDown(e, 'module', m.id)} onTouchStart={(e) => handlePointerDown(e, 'module', m.id)}><div className="w-3 h-3 bg-blue-500 rounded-full"></div></div>}
                                        </div>
                                    </div>
                                );
                            })}
                            {measurePreview && (
                                <svg style={{ position: 'absolute', left: 0, top: 0, overflow: 'visible', pointerEvents: 'none', zIndex: 99999 }}>
                                    <line x1={measurePreview.x} y1={measurePreview.y} x2={measurePreview.endX} y2={measurePreview.endY} stroke="#3b82f6" strokeWidth="2" strokeDasharray="4"/>
                                    <circle cx={measurePreview.x} cy={measurePreview.y} r="3" fill="#3b82f6" />
                                    <circle cx={measurePreview.endX} cy={measurePreview.endY} r="3" fill="#3b82f6" />
                                </svg>
                            )}
                            {snapHighlight && (
                                <div style={{ position: 'absolute', left: snapHighlight.x-5, top: snapHighlight.y-5, width: 10, height: 10, borderRadius: '50%', border: '2px solid #ec4899', zIndex: 99999, pointerEvents: 'none' }} />
                            )}
                        </div>
                    </div>

                    {/* Toolbar */}
                    {selectedId && !uiHidden && !measureMode && (
                        <div className="absolute bottom-24 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-5 py-2.5 rounded-2xl shadow-2xl flex gap-5 items-center z-30 ui-interactive transition-all" onMouseDown={e => e.stopPropagation()} onTouchStart={e => e.stopPropagation()}>
                             {modules.find(m => m.id === selectedId)?.type === 'module' && (
                                <>
                                <button onClick={(e) => { e.stopPropagation(); swapModule(modules.find(m => m.id === selectedId)); }} className="flex flex-col items-center gap-1 active:scale-90 transition-transform group">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 17H4M4 17l4 4M4 17l4-4M4 7h16M20 7l-4-4M20 7l-4 4"/></svg>
                                    <span className="text-[9px] uppercase opacity-70 font-medium">Swap</span>
                                </button>
                                <div className="w-px h-6 bg-gray-700 opacity-50"></div>
                                <button onClick={(e) => { e.stopPropagation(); rotateModule(modules.find(m => m.id === selectedId)); }} className="flex flex-col items-center gap-1 active:scale-90 transition-transform group">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                    <span className="text-[9px] uppercase opacity-70 font-medium">Rotate</span>
                                </button>
                                <div className="w-px h-6 bg-gray-700 opacity-50"></div>
                                <button onClick={(e) => { e.stopPropagation(); cycleColor(modules.find(m => m.id === selectedId)); }} className="flex flex-col items-center gap-1 active:scale-90 transition-transform group">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
                                    <span className="text-[9px] uppercase opacity-70 font-medium">Color</span>
                                </button>
                                <div className="w-px h-6 bg-gray-700 opacity-50"></div>
                                <button onClick={(e) => { e.stopPropagation(); duplicateModule(selectedId); }} className="flex flex-col items-center gap-1 active:scale-90 transition-transform group">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                    <span className="text-[9px] uppercase opacity-70 font-medium">Copy</span>
                                </button>
                                <div className="w-px h-6 bg-gray-700 opacity-50"></div>
                                <div className="flex flex-col gap-0.5">
                                    <button onClick={(e) => { e.stopPropagation(); setModules(prev => prev.map(m => m.id === selectedId ? { ...m, zIndex: (m.zIndex||0) + 1 } : m)); }} className="leading-none text-base">↑</button>
                                    <button onClick={(e) => { e.stopPropagation(); setModules(prev => prev.map(m => m.id === selectedId ? { ...m, zIndex: (m.zIndex||0) - 1 } : m)); }} className="leading-none text-base">↓</button>
                                </div>
                                <div className="w-px h-6 bg-gray-700 opacity-50"></div>
                                </>
                             )}
                            <button onClick={(e) => { e.stopPropagation(); removeModule(selectedId); }} className="flex flex-col items-center gap-1 text-red-400 hover:text-red-300 active:scale-90 transition-transform">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                <span className="text-[9px] uppercase opacity-70 font-medium">Del</span>
                            </button>
                        </div>
                    )}

                    {/* Bottom Bar */}
                    <div className="absolute bottom-6 left-4 right-4 z-30 flex gap-3 pointer-events-none">
                        <div className="flex-1 glass-panel shadow-lg rounded-2xl p-2 pl-4 flex items-center ui-interactive cursor-pointer hover:bg-white" onClick={(e) => { e.stopPropagation(); setIsPriceOpen(true); }} onMouseDown={e => e.stopPropagation()}>
                            <div className="flex flex-col"><span className="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Total Cost</span><span className="text-base font-bold text-gray-900">Ksh {totalPrice.toLocaleString()}</span></div>
                        </div>
                        <div className={`flex gap-3 transition-opacity duration-300 ${uiHidden ? 'opacity-0 pointer-events-none' : 'opacity-100'}`} onMouseDown={e => e.stopPropagation()}>
                            <button onClick={() => setSnapEnabled(!snapEnabled)} className={`w-14 h-14 backdrop-blur shadow-lg rounded-2xl flex items-center justify-center ui-interactive border-2 transition-colors ${snapEnabled ? 'bg-blue-50 border-blue-400 text-blue-600' : 'glass-panel border-transparent text-gray-400'}`}>
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            </button>
                            <button onClick={() => { setSelectedId(null); setUiHidden(true); }} className="w-14 h-14 glass-panel shadow-lg rounded-2xl flex items-center justify-center text-gray-700 ui-interactive hover:bg-white"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                            <button onClick={() => setIsPaletteOpen(true)} className="w-14 h-14 bg-black shadow-lg rounded-2xl flex items-center justify-center text-white text-3xl ui-interactive pb-1 active:scale-95 transition-transform">+</button>
                        </div>
                    </div>

                    {uiHidden && <button onClick={() => setUiHidden(false)} className="absolute bottom-6 right-4 w-14 h-14 glass-panel shadow-lg rounded-2xl flex items-center justify-center text-gray-900 ui-interactive z-40 animate-pulse" onMouseDown={e => e.stopPropagation()}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg></button>}

                    {/* Palette */}
                    {isPaletteOpen && (
                        <div className="absolute inset-0 z-40 bg-black/20 backdrop-blur-sm" onClick={() => setIsPaletteOpen(false)}>
                            <div className="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 h-[70vh] overflow-y-auto ui-interactive transition-transform" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold">Add Module</h3>
                                    <button onClick={() => addModule(LADY_URL, true)} className="bg-gray-100 px-3 py-1 text-xs font-bold rounded-full">+ Person</button>
                                </div>
                                <input type="text" placeholder="Search modules..." className="w-full bg-gray-100 rounded-xl px-4 py-3 mb-6 outline-none focus:ring-2 focus:ring-blue-500" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                <div className="grid grid-cols-2 gap-4 pb-12">
                                    {filteredMenu.map(p => (
                                        <button key={p.product} onClick={() => addModule(p.id)} className="flex flex-col items-center bg-gray-50 rounded-xl p-4 active:scale-95 transition-transform">
                                            <div className="w-24 h-24 relative mb-2"><object data={p.imagePath} type="image/svg+xml" className="w-full h-full pointer-events-none" /></div>
                                            <span className="text-xs font-medium text-center">{p.product}</span>
                                            <span className="text-[10px] text-gray-500">Ksh {p.price.toLocaleString()}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {isPriceOpen && (
                        <div className="absolute inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setIsPriceOpen(false)}>
                            <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl ui-interactive" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold">Details</h3>
                                    <button onClick={() => setIsPriceOpen(false)} className="bg-gray-100 w-8 h-8 rounded-full">×</button>
                                </div>
                                <div className="space-y-2 mb-6 max-h-[40vh] overflow-y-auto">
                                    {Object.entries(itemBreakdown).map(([n, d]) => (
                                        <div key={n} className="flex justify-between text-sm border-b pb-2"><span>{d.count}x {n}</span><span>Ksh {(d.price*d.count).toLocaleString()}</span></div>
                                    ))}
                                </div>
                                <div className="flex justify-between text-lg font-bold mb-6 pt-2 border-t"><span>Total</span><span>Ksh {totalPrice.toLocaleString()}</span></div>
                                <a href={`https://wa.me/254783891005?text=${encodeURIComponent('Sandbox Design Total: Ksh '+totalPrice.toLocaleString())}`} target="_blank" className="block w-full bg-green-600 text-white text-center py-3 rounded-xl font-bold shadow-lg">Order via WhatsApp</a>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Sandbox />);
    </script>
</body>
</html>